<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>☀ : kimshin - 테스트 불가능한 함수</title>
    <link href='https://cdn.rawgit.com/theeluwin/NotoSansKR-Hestia/master/stylesheets/NotoSansKR-Hestia.css' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" id="wp-pagenavi-css" href="/assets/css/base.css" type="text/css" media="all">
  </head>
  <body>
    <h1><a href="/">kimshin</a></h1>
    <p>Blog Blog Blog</p>
    <ul>
  
  <li><a href="/posts/">Posts</a></li>
</ul>

    <article class="post">
<h1>테스트 불가능한 함수</h1>
<p>Posted on Sunday, 1 Jan 2017 by 김신</p>
<p>버그를 발견했지만, 원인을 알 수 없는 상태에서 벗어나지 못할 때가 있다. 개발일을 하면서 만나는 모든 상황 중 가장 날 괴롭게 하는 상황이다. 왜냐면 문제를 해결하는 데 얼마나 걸릴지 알 수 없고, 알고 보니 또 다른 문제가 있는 경우가 많기 때문이다. 반면에 테스트 가능한 코드로 새로 쓰면 코드가 무슨 짓을 할지 예측할 수 있고 작업 일정도 예측할 수 있다.</p>
<p>그래서 테스트 불가능한 코드를 만나면 디버깅을 하지 않고 코드를 새로 쓰겠다고 마음먹었다. 예측할 수 없는 상황에서 빠져나오는 것이 항상 최우선이기 때문이다. 최악의 상황은 상상한 것보다 더 냉정할 때가 많다. 예측할 수 없는 코드는 매번 나에게 최악의 똥을 선사한다.</p>
<p>이 끔찍한 디버깅 늪의 가장 깊은 곳에는 테스트 불가능한 함수가 있었다. 보통 테스트의 기본 단위는 함수니깐 말이다. 디버깅 중 몇몇 함수들에게 사망 선고를 내리고 호흡기를 떼보면서 테스트 불가능한 함수의 공통점을 정리해봤다.</p>
<p>테스트 불가능한 함수는 10줄을 넘어간다. <a href="http://stackoverflow.com/questions/611304/how-many-lines-of-code-should-a-function-procedure-method-have">10줄</a>이면 한 가지 일을 하는데 대부분 충분하다. 루프문이 3개쯤 중첩되어있어도 10줄이면 충분하다. if, else로 10줄 이상 떡칠하는 것도 패턴을 찾으면 대부분 피할 수 있다. 그러니 함수 하나가 10줄이 넘어간다면 여러 가지 일을 하고 있다고 의심할 수밖에 없다. 각각의 일을 독립적으로 테스트하기 위해서는 함수를 쪼개야만 한다.</p>
<p>전역변수나 클래스 변수를 사용하는 경우도 많다. 같은 클래스의 다른 함수가 클래스 변수를 망쳐두는 경우가 있다. 클래스가 거대해지면 클래스 변수가 전역 변수랑 다를 바 없다. 어디선가 오용될 수 있다는 생각에 불안해진다. 그뿐만 아니라 클래스 변수는 상태에 따라 컨텍스트를 나눠서 테스트해야 해서 테스트 코드를 작성하기 어려워진다.</p>
<p>테스트 불가능한 함수는 외부로 입출력(파일, 로깅, 현재 시각, HTTP request 따위)을 한다. 가짜 데이터를 넣어 열심히 테스트해봤자 프로덕션 환경에서는 예기치 못한 버그가 나타난다. 파일 스토리지가 가득 차거나 머신의 타임존이 기대와 다르다거나 HTTP Response가 엉뚱하게 들어오거나 타임아웃 되는 미친 상황들이 프로덕션 환경에서는 왕왕 벌어진다.</p>
<p>외부로 데이터를 보내거나 받는 것은 인터페이스가 단순해도 아주 작은 함수로 따로 만들었으면 한다. <a href="http://david.heinemeierhansson.com/2014/tdd-is-dead-long-live-testing.html">TDD is dead. long live test</a>에서 하는 이야기가 그거다. 똑같은 인풋에 똑같은 아웃풋이 나오는 <a href="https://en.wikipedia.org/wiki/Pure_function">pure function</a>들은 굳이 테스트 코드를 작성해야 하나 싶을 만큼 명료해서 TDD is dead 같은 소리를 하는 거다. DB를 연결하거나 하는 시스템 테스트에 집중해야한다. 그러기 위해서는 시스템에 의존성이 있는 코드를 따로 분리해서 그것만 테스트 할 수 있어야 한다.</p>


  <p class="tags">
    
      <a href="/tags/UnitTest/">UnitTest</a>;
    
      <a href="/tags/TddIsDead/">TddIsDead</a>;
    
  </p>

</article>

  </body>
</html>
